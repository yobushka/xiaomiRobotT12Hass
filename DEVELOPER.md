# üõ† –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (Developer Guide)

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ MIoT –¥–ª—è –º–æ–¥–µ–ª–∏ `xiaomi.vacuum.b106bk` –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

## üîë –û—Å–Ω–æ–≤—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ Home Assistant API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é `xiaomi_miot`.

- **Endpoint:** `http://<HASS_HOST>:8123/api/services/xiaomi_miot/<service_name>`
- **Auth:** Bearer Token –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization`.

## üìã –ö–∞—Ä—Ç–∞ MIoT –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤

| –§—É–Ω–∫—Ü–∏—è | SIID | PIID / AIID | –¢–∏–ø | –ó–Ω–∞—á–µ–Ω–∏—è |
|---------|------|-------------|-----|----------|
| **Room Cleaning** | 7 | 3 (Action) | Start | `["ID", 0, 1]` |
| **Stop Vacuum** | 2 | 2 (Action) | Stop | - |
| **Get Room IDs** | 7 | 10 (Action) | Info | Input: `[map_id]` |
| **Suction Power** | 7 | 5 (Prop) | Set | 0-Silent, 1-Std, 2-Med, 3-Turbo |
| **Water Level** | 7 | 6 (Prop) | Set | 0-Low, 1-Mid, 2-High |
| **Cleaning Mode** | 2 | 4 (Prop) | Set | 0-Vacuum, 1-V&M, 2-Mop |

## üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç

### 1. –ü–∞—Å—Å–∏–≤–Ω–æ–µ (Action 7,10)
–ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ ID –∏–∑ –∫—ç—à–∞ –ø—ã–ª–µ—Å–æ—Å–∞. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞:
```mermaid
sequenceDiagram
    participant S as Script
    participant HA as Home Assistant
    participant V as Vacuum (b106bk)

    S->>HA: GET /api/states (Request map.cur_map_id)
    S->>HA: POST call_action (siid: 7, aiid: 10)
    V-->>S: Out: ["1_12_1...", "1_10_1..."]
```

### 2. –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (Bruteforce)
–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø—É—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–µ –æ—Ç –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞.
- **–õ–æ–≥–∏–∫–∞**: –ü–µ—Ä–µ–±–æ—Ä ID 10-20. –î–ª—è –∫–∞–∂–¥–æ–≥–æ ID –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `siid: 7, aiid: 3` (Start).
- **–û–∂–∏–¥–∞–Ω–∏–µ**: –°–∫—Ä–∏–ø—Ç –∂–¥–µ—Ç N —Å–µ–∫—É–Ω–¥ (–∑–∞–¥–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, 5-120), —á—Ç–æ–±—ã –ø—ã–ª–µ—Å–æ—Å —É—Å–ø–µ–ª –æ—Ç—ä–µ—Ö–∞—Ç—å –æ—Ç –±–∞–∑—ã –∏ —Å—Ç–∞—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º –≤ –Ω—É–∂–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ.
- **–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è**: –ï—Å–ª–∏ –ø—ã–ª–µ—Å–æ—Å –ø–æ–µ—Ö–∞–ª ‚Äî ID —Ä–∞–±–æ—á–∏–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∏–º—è.
- **–°–±—Ä–æ—Å**: –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ ID –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `stop` (`siid: 2, aiid: 2`), —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –ø—ã–ª–µ—Å–æ—Å –≤ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å.

## üöÄ –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (CURL)

### –°—Ç–∞—Ä—Ç —É–±–æ—Ä–∫–∏ –∫–æ–º–Ω–∞—Ç—ã 11
```bash
curl -X POST http://localhost:8123/api/services/xiaomi_miot/call_action 
  -H "Authorization: Bearer <TOKEN>" 
  -H "Content-Type: application/json" 
  -d '{
    "entity_id": "vacuum.xiaomi_b106bk_807e_robot_cleaner",
    "siid": 7,
    "aiid": 3,
    "params": ["11", 0, 1]
  }'
```

## üöÄ –î–µ–ø–ª–æ–π (Deployment)

–°–∫—Ä–∏–ø—Ç `setup_vacuum.py` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ Home Assistant.
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `.env`:
- `DEPLOY_TYPE`: 
    - `docker`: –î–ª—è HA, –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –≤ Docker. –ü—É—Ç—å –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ –∫ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É `scripts.yaml`.
    - `native`: –î–ª—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ HA.
    - `disable`: –¢–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
- `DEPLOY_PATH`: –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ü–µ–ª–µ–≤–æ–º—É —Ñ–∞–π–ª—É `scripts.yaml`.

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ —Å–∫—Ä–∏–ø—Ç:
1. –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é `scripts.yaml.bak`.
2. –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞.
3. –í—ã–∑—ã–≤–∞–µ—Ç `curl -X POST .../api/services/script/reload` –¥–ª—è –≥–æ—Ä—è—á–µ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.
